<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>1A2B æ•¸å­—çŒœè¬ï¼ˆ2-6ä½æ•¸ç‰ˆï¼‰</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #eee;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
  }
  h1 {
    margin: 20px 0 5px;
    color: #39ff14;
    text-shadow: 0 0 8px #39ff14;
  }
  .container {
    background: #222;
    padding: 20px 30px;
    border-radius: 12px;
    width: 320px;
    box-shadow: 0 0 15px #39ff14aa;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
  }
  select, input[type=number], button, input[type=text] {
    width: 100%;
    padding: 8px 10px;
    margin-top: 6px;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
    box-sizing: border-box;
  }
  button {
    background: #39ff14;
    color: #121212;
    font-weight: 700;
    cursor: pointer;
    margin-top: 20px;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: #2ecf0f;
  }
  button:disabled {
    background: #666;
    cursor: not-allowed;
  }
  .hidden {
    display: none;
  }
  #desc {
    margin-top: 15px;
    font-size: 0.9rem;
    color: #aaa;
    text-align: center;
  }
  #timer {
    margin-top: 15px;
    font-size: 1.1rem;
    text-align: center;
    font-weight: 700;
    color: #39ff14;
    text-shadow: 0 0 6px #39ff14aa;
  }
  #result {
    margin-top: 15px;
    font-size: 1.2rem;
    font-weight: 700;
    color: #ff4444;
    text-align: center;
    min-height: 1.5em;
  }
  ul.history {
    list-style: none;
    padding: 0;
    margin: 10px 0 0 0;
    max-height: 130px;
    overflow-y: auto;
    border: 1px solid #39ff14;
    border-radius: 6px;
    background: #111;
  }
  ul.history li {
    padding: 5px 8px;
    border-bottom: 1px solid #39ff14aa;
    font-family: monospace;
    font-size: 0.9rem;
  }
  ul.history li:last-child {
    border-bottom: none;
  }
  .versus-panel {
    margin-top: 15px;
    border-top: 1px solid #39ff14;
    padding-top: 15px;
  }
  #ai-status {
    margin-top: 8px;
    font-style: italic;
    color: #eee;
    min-height: 1.2em;
  }
  .flex-row {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  .flex-row > * {
    flex: 1;
  }
  .footer {
    margin: 20px 0;
    font-size: 0.8rem;
    color: #555;
  }
</style>
</head>
<body>

<h1></h1>

<div class="container" id="setupPanel">
  <label for="digitSelect">é¸æ“‡ä½æ•¸ (2-6ä½):</label>
  <select id="digitSelect">
    <option value="2">2 ä½æ•¸</option>
    <option value="3" selected>3 ä½æ•¸</option>
    <option value="4">4 ä½æ•¸</option>
    <option value="5">5 ä½æ•¸</option>
    <option value="6">6 ä½æ•¸</option>
  </select>

  <label for="modeSelect">é¸æ“‡æ¨¡å¼:</label>
  <select id="modeSelect">
    <option value="player" selected>å–®äººæ¨¡å¼ï¼ˆä½ çŒœï¼‰</option>
    <option value="versus">AI å°æˆ°æ¨¡å¼</option>
  </select>

  <label for="difficultySelect">AI é›£åº¦ï¼ˆå°æˆ°æ¨¡å¼æ‰æœ‰æ•ˆï¼‰:</label>
  <select id="difficultySelect" disabled>
    <option value="easy">ç°¡å–®</option>
    <option value="medium" selected>ä¸­ç­‰</option>
    <option value="hard">å›°é›£</option>
  </select>

  <button id="btnStart">é–‹å§‹éŠæˆ²</button>
</div>

<div class="container hidden" id="gamePanel">
  <div id="desc"></div>

  <div class="flex-row">
    <input type="text" id="guessInput" maxlength="6" placeholder="è¼¸å…¥ä½ çš„çŒœæ¸¬" autocomplete="off" />
    <button id="btnGuess">çŒœï¼</button>
  </div>

  <div id="timer">è¨ˆæ™‚ï¼š00:00</div>

  <ul class="history" id="historyList" title="ç©å®¶çŒœæ¸¬æ­·å²"></ul>

  <div class="versus-panel hidden" id="versusPanel">
    <div><strong>AI çŒœæ¸¬æ­·å²</strong></div>
    <ul class="history" id="aiHistoryList" title="AI çŒœæ¸¬æ­·å²"></ul>
    <div id="ai-status"></div>
  </div>

  <div id="result"></div>
  <button id="btnRestart" class="hidden">é‡æ–°é–‹å§‹</button>
</div>

<div class="footer">æç¤ºï¼šçŒœå°æ‰€æœ‰æ•¸å­—èˆ‡ä½ç½®ï¼Œå³ç‚º4A0B (æˆ–å°æ‡‰ä½æ•¸çš„å®Œå…¨æ­£ç¢º)</div>

<script>
(() => {
  const digitSelect = document.getElementById('digitSelect');
  const modeSelect = document.getElementById('modeSelect');
  const difficultySelect = document.getElementById('difficultySelect');
  const btnStart = document.getElementById('btnStart');
  const setupPanel = document.getElementById('setupPanel');
  const gamePanel = document.getElementById('gamePanel');
  const desc = document.getElementById('desc');
  const guessInput = document.getElementById('guessInput');
  const btnGuess = document.getElementById('btnGuess');
  const timerEl = document.getElementById('timer');
  const historyList = document.getElementById('historyList');
  const resultEl = document.getElementById('result');
  const versusPanel = document.getElementById('versusPanel');
  const aiHistoryList = document.getElementById('aiHistoryList');
  const aiStatus = document.getElementById('ai-status');
  const btnRestart = document.getElementById('btnRestart');

  let answer = '';
  let digit = 3;
  let mode = 'player';
  let aiDifficulty = 'medium';
  let gameOver = false;
  let startTime = null;
  let timerInterval = null;
  let playerTurn = true;

  // AI State & variables
  let aiCurrentGuess = null;
  let aiLastResult = null;
  let aiAutoTimer = null;
  let aiStrategy = null;

  // ----------- å·¥å…·å‡½æ•¸ -------------

  // ç”¢ç”Ÿä¸é‡è¤‡çš„æ•¸å­—å­—ä¸² (digitä½)
  function generateAnswer() {
    const digits = [];
    while (digits.length < digit) {
      let n = Math.floor(Math.random() * 10).toString();
      if (!digits.includes(n)) digits.push(n);
    }
    return digits.join('');
  }

  // æª¢æŸ¥è¼¸å…¥æ˜¯å¦åˆæ³•ï¼šé•·åº¦digitï¼Œä¸”æ•¸å­—ä¸”ä¸é‡è¤‡
  function isValidGuess(str) {
    if (str.length !== digit) return false;
    if (!/^\d+$/.test(str)) return false;
    const chars = [...str];
    return new Set(chars).size === digit;
  }

  // è¨ˆç®—AB (Aæ˜¯å®Œå…¨æ­£ç¢ºï¼ŒBæ˜¯æ•¸å­—æ­£ç¢ºä½†ä½ç½®éŒ¯èª¤)
  function getAB(guess, ans) {
    let A = 0, B = 0;
    for (let i = 0; i < digit; i++) {
      if (guess[i] === ans[i]) {
        A++;
      } else if (ans.includes(guess[i])) {
        B++;
      }
    }
    return { A, B };
  }

  // æ™‚é–“æ ¼å¼ mm:ss
  function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

  // åŠ å…¥æ­·å²ç´€éŒ„
  function addHistory(guess, result, listEl) {
    const li = document.createElement('li');
    li.textContent = `${guess} â†’ ${result.A}A${result.B}B`;
    listEl.prepend(li);
  }

  // æ¸…ç©ºæ­·å²
  function clearHistory() {
    historyList.innerHTML = '';
    aiHistoryList.innerHTML = '';
  }

  // è¨ˆæ™‚å™¨æ›´æ–°
  function updateTimer() {
    if (!startTime || gameOver) return;
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    timerEl.textContent = `è¨ˆæ™‚ï¼š${formatTime(elapsed)}`;
  }

  // éŠæˆ²çµæŸè™•ç†
  function endGame(msg) {
    gameOver = true;
    clearInterval(timerInterval);
    clearTimeout(aiAutoTimer);
    resultEl.textContent = msg;
    guessInput.disabled = true;
    btnGuess.disabled = true;
    aiStatus.textContent = '';
    btnRestart.classList.remove('hidden');
  }

  // é‡ç½®éŠæˆ²é¢æ¿ç‹€æ…‹
  function resetGamePanel() {
    startTime = null;
    clearInterval(timerInterval);
    clearTimeout(aiAutoTimer);
    timerEl.textContent = 'è¨ˆæ™‚ï¼š00:00';
    clearHistory();
    resultEl.textContent = '';
    guessInput.value = '';
    guessInput.disabled = false;
    btnGuess.disabled = false;
    gameOver = false;
    playerTurn = true;
    aiCurrentGuess = null;
    aiLastResult = null;
    aiStatus.textContent = '';
  }

  // -------- AI ç­–ç•¥ç‰©ä»¶ --------------

  // åŸºæœ¬AIç­–ç•¥ï¼Œæœƒéæ¿¾å¯è¡Œè§£ç©ºé–“ä¸¦çŒœä¸‹ä¸€å€‹
  class BasicAI {
    constructor() {
      this.possible = [];
    }
    reset() {
      this.possible = generateAllCandidates();
    }
    getNextGuess() {
      if (this.possible.length === 0) return null;
      // ç°¡å–®å–ç¬¬ä¸€å€‹å€™é¸
      return this.possible[0];
    }
    updatePool(guess, result) {
      this.possible = this.possible.filter(item => {
        const r = getAB(item, guess);
        return r.A === result.A && r.B === result.B;
      });
    }
    // é«˜é›£åº¦éœ€è¦çš„æ–¹æ³•ä½”ä½
    syncPlayerGuess() {}
  }

  // ä¸­ç­‰AIï¼šéš¨æ©Ÿå¾å€™é¸è§£ç©ºé–“çŒœ
  class MediumAI extends BasicAI {
    getNextGuess() {
      if (this.possible.length === 0) return null;
      const idx = Math.floor(Math.random() * this.possible.length);
      return this.possible[idx];
    }
  }

  // å›°é›£AIï¼šæœƒæå‰çŒœï¼ˆ3~5ç§’ï¼‰ï¼ŒæœƒåŒæ­¥åƒè€ƒç©å®¶çŒœæ¸¬çµæœï¼Œä¸¦ä¸”è‡ªå·±æœƒæ›´æ–°
  class HardAI extends BasicAI {
    constructor() {
      super();
      this.playerGuessHistory = [];
    }
    reset() {
      super.reset();
      this.playerGuessHistory = [];
    }
    getNextGuess() {
      if (this.possible.length === 0) return null;
      // ç°¡å–®æŒ‘ä¸­é–“
      return this.possible[Math.floor(this.possible.length / 2)];
    }
    updatePool(guess, result) {
      super.updatePool(guess, result);
    }
    syncPlayerGuess(playerGuess, playerResult) {
      this.playerGuessHistory.push({guess: playerGuess, result: playerResult});
      // éæ¿¾è‡ªå·±å€™é¸è§£ç©ºé–“åŒæ™‚åƒè€ƒç©å®¶çŒœæ¸¬éæ¿¾
      this.possible = this.possible.filter(candidate => {
        // æ¯å€‹ç©å®¶çŒœæ¸¬çµæœéƒ½å¿…é ˆåœ¨ candidate ä¸ŠåŒ¹é…
        return this.playerGuessHistory.every(({guess, result}) => {
          const r = getAB(candidate, guess);
          return r.A === result.A && r.B === result.B;
        });
      });
    }
  }

  // ç”¢ç”Ÿæ‰€æœ‰å¯èƒ½è§£ (digitä½æ•¸ï¼Œä¸é‡è¤‡æ•¸å­—)
  function generateAllCandidates() {
    const results = [];
    function dfs(path) {
      if (path.length === digit) {
        results.push(path.join(''));
        return;
      }
      for(let i=0;i<=9;i++) {
        const s = i.toString();
        if (!path.includes(s)) {
          path.push(s);
          dfs(path);
          path.pop();
        }
      }
    }
    dfs([]);
    return results;
  }

  // ------------ ä¸»æµç¨‹ -------------

  function startGame() {
    digit = parseInt(digitSelect.value);
    mode = modeSelect.value;
    aiDifficulty = difficultySelect.value;

    answer = generateAnswer();

    resetGamePanel();

    if (mode === 'player') {
      desc.textContent = `è«‹è¼¸å…¥ ${digit} ä½ä¸é‡è¤‡çš„æ•¸å­—é€²è¡ŒçŒœæ¸¬`;
      versusPanel.classList.add('hidden');
    } else {
      desc.textContent = `ç©å®¶èˆ‡ AI è¼ªæµçŒœæ•¸å­—ï¼Œé›£åº¦è¶Šé«˜AIè¶Šæœƒæå‰å‡ºæ‹›ï¼`;
      versusPanel.classList.remove('hidden');

      switch(aiDifficulty) {
        case 'easy':
          aiStrategy = new BasicAI();
          break;
        case 'medium':
          aiStrategy = new MediumAI();
          break;
        case 'hard':
          aiStrategy = new HardAI();
          break;
        default:
          aiStrategy = new MediumAI();
      }
      aiStrategy.reset();
    }

    setupPanel.classList.add('hidden');
    gamePanel.classList.remove('hidden');

    guessInput.maxLength = digit;
    guessInput.placeholder = `è¼¸å…¥ä½ çš„çŒœæ¸¬ (${digit}ä½ä¸é‡è¤‡æ•¸å­—)`;

    // å¦‚æœAIæ¨¡å¼ä¸”é›£åº¦é«˜ï¼ŒAIå…ˆçŒœçš„å¯èƒ½æ€§å¯æ“´å±•å¾Œé¢
  }

  function handlePlayerGuess() {
    if (gameOver) return;
    const guess = guessInput.value.trim();
    if (!isValidGuess(guess)) {
      alert(`è«‹è¼¸å…¥${digit}ä½ä¸é‡è¤‡çš„æ•¸å­—ï¼`);
      return;
    }

    if (!startTime) {
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    }

    const result = getAB(guess, answer);
    addHistory(guess, result, historyList);

    if (mode === 'versus' && aiDifficulty === 'hard') {
      aiStrategy.syncPlayerGuess(guess, result);
    }

    if (result.A === digit) {
      endGame('ç©å®¶è´äº†ï¼ğŸ‰');
      return;
    }

    guessInput.value = '';

    if (mode === 'player') {
      return; // ç©å®¶ç¹¼çºŒçŒœ
    }

    // AI æ¨¡å¼ï¼šè™•ç†AIçŒœæ¸¬
    playerTurn = false;
    guessInput.disabled = true;
    btnGuess.disabled = true;
    aiStatus.textContent = 'AI çŒœæ¸¬ä¸­...';

    if (aiDifficulty === 'hard') {
      if (!aiAutoTimer) scheduleAiAutoGuess();
      aiStatus.textContent = 'AI æœƒæå‰åœ¨3~5ç§’å…§è‡ªå‹•çŒœï¼';
      return;
    }

    setTimeout(() => aiGuess(), 600);
  }

  function aiGuess() {
    if (gameOver) return;
    if (!aiCurrentGuess) {
      aiCurrentGuess = aiStrategy.getNextGuess();
      if (!aiCurrentGuess) {
        endGame('AI ç„¡æ³•çŒœå‡ºç­”æ¡ˆï¼Œç©å®¶å‹åˆ©ï¼');
        return;
      }
    }

    if (!startTime) {
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    }

    const result = getAB(aiCurrentGuess, answer);
    addHistory(aiCurrentGuess, result, aiHistoryList);

    if (result.A === digit) {
      endGame('AI è´äº†ï¼ğŸ¤–');
      return;
    }

    aiStrategy.updatePool(aiCurrentGuess, result);
    aiCurrentGuess = aiStrategy.getNextGuess();

    if (!aiCurrentGuess) {
      endGame('AI ç„¡æ³•çŒœå‡ºç­”æ¡ˆï¼Œç©å®¶å‹åˆ©ï¼');
      return;
    }

    playerTurn = true;
    aiStatus.textContent = 'è¼ªåˆ°ç©å®¶çŒœäº†ï¼';
    guessInput.disabled = false;
    btnGuess.disabled = false;
  }

  // æœ€é«˜é›£åº¦AIè‡ªå‹•æå‰çŒœ
  function scheduleAiAutoGuess() {
    if (gameOver) return;
    const delay = 3000 + Math.random() * 2000; // 3~5ç§’

    aiAutoTimer = setTimeout(() => {
      if (gameOver) return;

      aiCurrentGuess = aiStrategy.getNextGuess();
      if (!aiCurrentGuess) {
        endGame('AI ç„¡æ³•çŒœå‡ºç­”æ¡ˆï¼Œç©å®¶å‹åˆ©ï¼');
        return;
      }

      if (!startTime) {
        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
      }

      const result = getAB(aiCurrentGuess, answer);
      addHistory(aiCurrentGuess, result, aiHistoryList);

      if (result.A === digit) {
        endGame('AI è´äº†ï¼ğŸ¤–');
        return;
      }

      aiStrategy.updatePool(aiCurrentGuess, result);

      // ç¹¼çºŒé æ’ä¸‹ä¸€æ¬¡çŒœæ¸¬
      scheduleAiAutoGuess();

      // AIçŒœå®Œï¼Œè¼ªåˆ°ç©å®¶
      playerTurn = true;
      aiStatus.textContent = 'è¼ªåˆ°ç©å®¶çŒœäº†ï¼';
      guessInput.disabled = false;
      btnGuess.disabled = false;

    }, delay);
  }

  btnStart.addEventListener('click', startGame);
  btnGuess.addEventListener('click', handlePlayerGuess);
  guessInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') btnGuess.click();
  });

  btnRestart.addEventListener('click', () => {
    setupPanel.classList.remove('hidden');
    gamePanel.classList.add('hidden');
  });

  modeSelect.addEventListener('change', () => {
    difficultySelect.disabled = modeSelect.value !== 'versus';
  });
})();
</script>

</body>
</html>
