<!DOCTYPE html>
<html>
<head>
  <title>Rectangle Dino V5</title>
  <style>
    * { margin: 0; overflow: hidden; background: #f0f0f0; }
    canvas { display: block; margin: 0 auto; background: white; border: 1px solid #ccc; }
  </style>
</head>
<body>
<canvas id="game" width="800" height="300"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// === éŠæˆ²ç‹€æ…‹ ===
let player = { x: 50, y: 240, width: 40, height: 40, vy: 0, jumping: false };
let gravity = 0.8;
let ground = 280;
let obstacles = [];
let items = [];
let bullets = [];
let frame = 0;
let score = 0;
let speed = 6;
let obstacleFreq = 90;
let started = false;
let paused = false;
let gameOver = false;
let flappyMode = false;
let flappyTimer = 0;
let bulletCount = 0;

// === è¼¸å…¥é›£åº¦è¨­å®š ===
function askDifficulty() {
  const speedInput = prompt("è«‹è¼¸å…¥åˆå§‹é€Ÿåº¦ (å»ºè­° 4~12)ï¼š", "6");
  const freqInput = prompt("è«‹è¼¸å…¥éšœç¤™ç‰©å‡ºç¾é »ç‡ï¼ˆæ•¸å­—è¶Šå°è¶Šå¯†ï¼Œå»ºè­° 60~150ï¼‰ï¼š", "90");
  const sp = parseFloat(speedInput);
  const fq = parseInt(freqInput);
  if (!isNaN(sp) && sp > 0) speed = sp;
  if (!isNaN(fq) && fq > 10) obstacleFreq = fq;
}

function resetGame() {
  player.y = 240;
  player.vy = 0;
  player.jumping = false;
  obstacles = [];
  items = [];
  bullets = [];
  frame = 0;
  score = 0;
  bulletCount = 0;
  flappyMode = false;
  flappyTimer = 0;
  gameOver = false;
  askDifficulty();
  loop();
}

// === ç”Ÿæˆéšœç¤™ç‰©èˆ‡é“å…· ===
function spawnObstacle() {
  const width = 20 + Math.random() * 30;
  const height = 20 + Math.random() * 40;
  const isFloating = Math.random() < 0.3;
  const y = isFloating ? ground - height - (40 + Math.random() * 60) : ground - height;
  obstacles.push({ x: 800, y, width, height });
  // 20% æ©Ÿç‡åŠ é“å…·
  if (Math.random() < 0.2) spawnItem();
}

function spawnItem() {
  const type = ["flappy", "bomb", "bullet"][Math.floor(Math.random() * 3)];
  const x = 800;
  const y = ground - 60 - Math.random() * 100;
  items.push({ x, y, width: 20, height: 20, type });
}

// === æ§åˆ¶ ===
document.addEventListener("keydown", e => {
  if (!started && e.code === "Space") {
    askDifficulty();
    started = true;
    loop();
  } else if (e.code === "Space" && !paused && !gameOver) {
    if (flappyMode) {
      player.vy = -6; // Flappy æ¨¡å¼è·³æ¯”è¼ƒçŸ­
    } else if (!player.jumping) {
      player.vy = -15;
      player.jumping = true;
    }
  } else if (e.code === "KeyP") {
    paused = !paused;
    if (!paused && !gameOver) loop();
  } else if (e.code === "Enter" && gameOver) {
    resetGame();
  } else if (e.code === "KeyF" && bulletCount > 0) {
    bullets.push({ x: player.x + player.width, y: player.y + player.height / 2, speed: 10 });
    bulletCount--;
  }
});

function update() {
  // é‡åŠ› & ç§»å‹•
  player.vy += gravity;
  player.y += player.vy;
  if (player.y >= ground - player.height) {
    player.y = ground - player.height;
    player.vy = 0;
    player.jumping = false;
  }

  // Flappy æ¨¡å¼å€’æ•¸
  if (flappyMode) {
    flappyTimer--;
    if (flappyTimer <= 0) {
      flappyMode = false;
    }
  }

  // Spawn éšœç¤™ç‰©
  if (frame % obstacleFreq === 0) spawnObstacle();

  // ç§»å‹•éšœç¤™ç‰© + ç¢°æ’æª¢æŸ¥
  for (let obs of obstacles) {
    obs.x -= speed;

    if (
      player.x < obs.x + obs.width &&
      player.x + player.width > obs.x &&
      player.y < obs.y + obs.height &&
      player.y + player.height > obs.y
    ) {
      gameOver = true;
    }
  }

  // é“å…·ç§»å‹• + åƒå–æª¢æŸ¥
  for (let item of items) {
    item.x -= speed;
    if (
      player.x < item.x + item.width &&
      player.x + player.width > item.x &&
      player.y < item.y + item.height &&
      player.y + player.height > item.y
    ) {
      if (item.type === "flappy") {
        flappyMode = true;
        flappyTimer = 600; // 10 ç§’ï¼ˆ60FPSï¼‰
      } else if (item.type === "bomb") {
        obstacles = [];
      } else if (item.type === "bullet") {
        bulletCount += 1 + Math.floor(Math.random() * 3); // 1~3 ç™¼
      }
      item.collected = true;
    }
  }
  items = items.filter(i => !i.collected && i.x + i.width > 0);

  // å­å½ˆç§»å‹• + æ“Šæ¯€éšœç¤™
  for (let b of bullets) {
    b.x += b.speed;
    for (let obs of obstacles) {
      if (
        b.x < obs.x + obs.width &&
        b.x + 5 > obs.x &&
        b.y > obs.y &&
        b.y < obs.y + obs.height
      ) {
        obs.hit = true;
        b.hit = true;
      }
    }
  }
  bullets = bullets.filter(b => !b.hit && b.x < canvas.width);
  obstacles = obstacles.filter(o => !o.hit && o.x + o.width > 0);

  // åˆ†æ•¸ & é›£åº¦
  if (frame % 5 === 0) score++;
  if (frame % 200 === 0) speed += 0.3;
  frame++;
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#999";
  ctx.fillRect(0, ground, canvas.width, 3);

  // ç©å®¶
  ctx.fillStyle = flappyMode ? "#00ccff" : "#3498db";
  ctx.fillRect(player.x, player.y, player.width, player.height);

  // éšœç¤™ç‰©
  ctx.fillStyle = "#e74c3c";
  for (let obs of obstacles) {
    ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
  }

  // é“å…·
  for (let item of items) {
    if (item.type === "flappy") ctx.fillStyle = "#00ccff";
    else if (item.type === "bomb") ctx.fillStyle = "#ff9900";
    else if (item.type === "bullet") ctx.fillStyle = "#cc0000";
    ctx.fillRect(item.x, item.y, item.width, item.height);
  }

  // å­å½ˆ
  ctx.fillStyle = "black";
  for (let b of bullets) {
    ctx.fillRect(b.x, b.y - 2, 6, 4);
  }

  // UI
  ctx.fillStyle = "black";
  ctx.font = "16px sans-serif";
  ctx.fillText(`Score: ${score}`, 10, 20);
  ctx.fillText(`Bullets: ${bulletCount}`, 10, 40);
  if (flappyMode) ctx.fillText("ğŸ•Šï¸ Flappy Mode!", 10, 60);

  if (paused) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "30px sans-serif";
    ctx.fillText("â¸ï¸ Paused (Press P to Resume)", 200, 150);
  }

  if (gameOver) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "30px sans-serif";
    ctx.fillText(`ğŸ’€ Game Over - Score: ${score}`, 220, 130);
    ctx.font = "20px sans-serif";
    ctx.fillText("Press Enter to Restart", 290, 170);
  }

  if (!started) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "30px sans-serif";
    ctx.fillText("ğŸŸ¦ Rectangle Dino V5 ğŸŸ¥", 250, 100);
    ctx.font = "20px sans-serif";
    ctx.fillText("Press SPACE to Start", 300, 150);
    ctx.fillText("SPACE = Jump | P = Pause | F = Shoot", 240, 180);
  }
}

function loop() {
  if (!paused && !gameOver && started) update();
  draw();
  if (!gameOver && started) requestAnimationFrame(loop);
}
</script>
</body>
</html>
